<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Angelopp — Public Logbook</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #111; }
    header { padding: 18px 22px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 18px; font-weight: 700; }
    header p { margin: 6px 0 0; opacity: .85; font-size: 13px; }
    main { max-width: 900px; margin: 18px auto; padding: 0 14px 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; margin: 12px 0; }
    .card { background: #fff; border-radius: 10px; padding: 12px 14px; box-shadow: 0 1px 10px rgba(0,0,0,.06); flex: 1; min-width: 260px; }
    .meta { font-size: 12px; opacity: .7; margin-bottom: 6px; display: flex; gap: 10px; flex-wrap: wrap; }
    .msg { white-space: pre-wrap; line-height: 1.35; }
    button { border: 0; border-radius: 8px; padding: 10px 12px; font-weight: 700; cursor: pointer; background:#2563eb; color:#fff; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    select, input { padding: 9px 10px; border: 1px solid #d1d5db; border-radius: 8px; }
    .small { font-size: 12px; opacity:.75; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; }
    @media (min-width: 720px){ .grid { grid-template-columns: 1fr 1fr; } }
    footer { margin-top: 16px; font-size: 12px; opacity:.7; }
    code { background:#f3f4f6; padding:2px 5px; border-radius:6px; }
  </style>
</head>
<body>
<header>
  <h1>Angelopp — Public Logbook (Anonymous)</h1>
  <p>Everything said in channels can be read publicly — phone numbers and names are never stored here.</p>
</header>

<main>
  <div class="row">
    <div class="card">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="refreshBtn">Refresh</button>
        <label class="small">Limit:
          <select id="limitSel">
            <option>20</option>
            <option selected>50</option>
            <option>100</option>
            <option>200</option>
          </select>
        </label>
        <label class="small">Filter category:
          <select id="catSel">
            <option value="">(all)</option>
            <option>Community</option>
            <option>Business</option>
            <option>Sacco</option>
            <option>Osusu</option>
            <option>Education</option>
            <option>Entertainment</option>
          </select>
        </label>
        <span class="small" id="status"></span>
      </div>
      <div class="small" style="margin-top:10px;">
        API: <code>/public/latest</code> and <code>/public/stats</code>
      </div>
    </div>

    <div class="card">
      <div class="meta"><b>Stats (last 14 days)</b></div>
      <div id="statsBox" class="small">Loading…</div>
    </div>
  </div>

  <div class="card">
    <div class="meta"><b>Latest messages</b></div>
    <div id="list" class="grid"></div>
    <footer>
      Privacy rules: stable pseudonyms, salted hashing, and phone-like strings masked in text.
    </footer>
  </div>
</main>

<script>
  const $ = (id)=>document.getElementById(id);

  async function fetchJSON(url){
    const r = await fetch(url, {cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json();
  }

  function esc(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;");
  }

  function renderMessages(items){
    const list = $("list");
    list.innerHTML = "";
    for(const it of items){
      const div = document.createElement("div");
      div.className = "card";
      const meta = `${esc(it.created_at)} · ${esc(it.category)} · ${esc(it.channel_name||"")} · ${esc(it.author_anon)}`;
      div.innerHTML = `
        <div class="meta">${meta}</div>
        <div class="msg">${esc(it.text)}</div>
      `;
      list.appendChild(div);
    }
  }

  function renderStats(stats){
    const perDay = stats.per_day || [];
    const perCat = stats.per_category || [];
    let html = "<b>Messages per day</b><br/>";
    html += perDay.map(x=> `${esc(x.day)}: <b>${esc(x.n)}</b>`).join("<br/>");
    html += "<br/><br/><b>By category</b><br/>";
    html += perCat.map(x=> `${esc(x.category)}: <b>${esc(x.n)}</b>`).join("<br/>");
    $("statsBox").innerHTML = html || "(none)";
  }

  async function loadAll(){
    $("refreshBtn").disabled = true;
    $("status").textContent = "Loading…";
    try{
      const limit = $("limitSel").value;
      const cat = $("catSel").value;
      const url = cat ? `/public/latest?limit=${limit}&category=${encodeURIComponent(cat)}` : `/public/latest?limit=${limit}`;
      const [msgs, stats] = await Promise.all([fetchJSON(url), fetchJSON("/public/stats")]);
      renderMessages(msgs);
      renderStats(stats);
      $("status").textContent = `OK — ${msgs.length} shown`;
    }catch(e){
      $("status").textContent = "Error: "+e.message;
    }finally{
      $("refreshBtn").disabled = false;
    }
  }

  $("refreshBtn").onclick = loadAll;
  $("limitSel").onchange = loadAll;
  $("catSel").onchange = loadAll;
  loadAll();
</script>
</body>
</html>
